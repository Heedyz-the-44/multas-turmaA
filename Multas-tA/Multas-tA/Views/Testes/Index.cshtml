
@{
    ViewBag.Title = "Index";
}

<h2>Index</h2>

<div class="container">
    <div class="row" id="grelha-agentes"></div>

    <hr />

    <form id="adicionar-agente" enctype="multipart/form-data">
        <div class="form-group">
            <label for="nome" class="control-label">Nome</label>
            <input class="form-control" type="text" name="nome" id="nome" />
        </div>

        <div class="form-group">
            <label for="esquadra" class="control-label">Esquadra</label>
            <input class="form-control" type="text" name="esquadra" id="esquadra" />
        </div>

        <button class="btn btn-primary" type="submit">Adicionar agente</button>
    </form>
</div>

@* Container para "templates" *@
<div class="hidden">
    <div id="template-agente" class="col-sm-3">
        <a href="#" class="thumbnail">
            <img class="img-responsive"/>
            <div class="caption">
                <h3></h3>
                <p></p>
            </div>
        </a>
    </div>
</div>

<script>
    function getAgentes() {
        return fetch("/api/agentes", {
            headers: { 'Accept': 'application/json' }
        })
            .then(resposta => resposta.json())
    }

    function divAgente(agente) {
        let template = document.querySelector('#template-agente')
            .cloneNode(true);

        template.removeAttribute('id');

        let fotoAgente = template.querySelector('img');

        if (agente.Fotografia != null) {
            fotoAgente.src = `/imagens/${agente.Fotografia}`;
        } else {
            fotoAgente.classList.add('hidden');
        }

        template.querySelector('.caption > h3').textContent = agente.Nome;
        template.querySelector('.caption > p').textContent = `Esquadra: ${agente.Esquadra}`;

        return template;
    }

    function adicionarAgente(agente) {
        let template = divAgente(agente);

        let grelha = document.querySelector('#grelha-agentes');

        grelha.appendChild(template);
    }

    function iniciarAgentes() {
        getAgentes()
            .then(agentes => {
                let grelha = document.querySelector('#grelha-agentes');

                for (let agente of agentes) {
                    adicionarAgente(agente);
                }
            })
    }

    document.querySelector('#adicionar-agente').addEventListener('submit', function (e) {
        e.preventDefault();

        let form = this;

        let agente = {
            Nome: form.querySelector('[name=nome]').value,
            Esquadra: form.querySelector('[name=esquadra]').value
        };

        let jsonData = JSON.stringify(agente);

        fetch('/api/agentes', {
            method: 'post',
            headers: { 'Content-Type': 'application/json' },
            body: jsonData
        })
            .then(resposta => {
                if (resposta.ok) {
                    return resposta.json();
                } else {
                    return Promise.reject(resposta.json());
                }
            })
            .then(novoAgente => adicionarAgente(novoAgente));
    });

    iniciarAgentes();
</script>